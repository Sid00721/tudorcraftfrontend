import{Q as _,x as $,r,s as P,j as e,B as p,c as l,T as n,L as R,b as c,w as u,E as B,G as q,y as G}from"./index-3v-V_ujV.js";import{u as Y}from"./usePageTitle-seETqNZq.js";import{A as I}from"./Alert-Cd_pZj5V.js";import{T as J,a as U,b as H,c as m,d as i,e as Q}from"./TableRow-Ch5q5_jA.js";import{L as Z}from"./ListItem-Da3YSJce.js";import{f as K}from"./index-DyFXVJrh.js";import"./Close-BLRrZJzV.js";import"./isMuiElement-Dd43ylT-.js";import"./format-CyxUvML0.js";const x="https://tutor-matching-backend.onrender.com",V=o=>{switch(o){case"SUCCESS":return"success";case"ERROR":return"error";default:return"info"}};function le(){const{trialId:o}=_(),g=$(),[L,y]=r.useState(!0),[a,A]=r.useState(null),[d,b]=r.useState([]);Y(a?`Trial: ${a.student_name}`:"Trial Details");const[T,M]=r.useState([]),[j,w]=r.useState(!1),[S,C]=r.useState(null),[v,k]=r.useState(!1),[E,O]=r.useState(!1),h=r.useCallback(async()=>{const{data:s,error:t}=await P.from("trial_requests").select("*").eq("id",o).single();if(t)g("/");else{A(s);const{data:f,error:W}=await P.from("logs").select("*").eq("trial_request_id",o).order("created_at",{ascending:!1});M(f||[])}},[o,g]);r.useEffect(()=>{y(!0),h().finally(()=>y(!1))},[h]);const F=async()=>{w(!0),b([]);try{const s=await fetch(`${x}/api/match-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({trialId:a.id})}),t=await s.json();if(s.ok&&t.matchedTutors)b(t.matchedTutors);else throw new Error(t.error||"Failed to fetch matches.")}catch{alert("Failed to fetch matches. Is the backend server running?")}w(!1)},z=async s=>{C(s);try{const t=await fetch(`${x}/api/trials/${o}/assign`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tutorId:s})}),f=await t.json();if(!t.ok)throw new Error(f.error||"Failed to assign tutor.");alert("Tutor successfully assigned and trial confirmed!"),g("/")}catch(t){alert("Error: "+t.message)}C(null)},D=async()=>{k(!0);try{const s=await fetch(`${x}/api/trials/${o}/start-outreach`,{method:"POST"}),t=await s.json();if(!s.ok)throw new Error(t.message||"Failed to start outreach.");alert(t.message),await h()}catch(s){alert("Error: "+s.message)}k(!1)},N=async()=>{O(!0);try{const s=await fetch(`${x}/api/trials/${o}/retry`,{method:"POST"}),t=await s.json();if(!s.ok)throw new Error(t.error||"Failed to retry outreach.");alert(t.message),await h()}catch(s){alert("Error: "+s.message)}O(!1)};return L?e.jsx(p,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(l,{})}):a?e.jsxs(p,{sx:{p:3},children:[e.jsx(c,{component:R,to:"/",sx:{mb:2},children:"â† Back to Dashboard"}),e.jsxs(u,{sx:{p:3,mb:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Trial Request Details"}),e.jsxs(n,{children:[e.jsx("strong",{children:"Subject:"})," ",a.subject]}),e.jsxs(n,{children:[e.jsx("strong",{children:"Location:"})," ",a.location]}),e.jsxs(n,{children:[e.jsx("strong",{children:"Status:"})," ",a.status]})]}),["Confirmed","Outreach in Progress"].includes(a.status)&&e.jsx(I,{severity:a.status==="Confirmed"?"success":"info",sx:{mb:2},children:a.status==="Confirmed"?"This trial has been confirmed and assigned.":"Automated outreach is currently in progress."}),a.status==="Failed - No Tutors"&&e.jsx(I,{severity:"error",action:e.jsx(c,{color:"inherit",size:"small",onClick:N,disabled:E,children:E?e.jsx(l,{size:24,color:"inherit"}):"Re-open and Retry Outreach"}),sx:{mb:2},children:"This outreach failed to find an available tutor. You can add new tutors and try again."}),d.length>0&&a.status==="Pending"&&e.jsxs(u,{sx:{p:2,mb:4,backgroundColor:"#e8f4fd"},children:[e.jsx(n,{variant:"h6",children:"Ready to Go!"}),e.jsxs(n,{sx:{mb:2},children:["You have a shortlist of ",d.length," tutors. You can now start the automated outreach."]}),e.jsx(c,{variant:"contained",color:"primary",onClick:D,disabled:v,children:v?e.jsx(l,{size:24}):"Start Automated Outreach"})]}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(n,{variant:"h5",children:"Manual Controls"}),a.status==="Pending"&&e.jsx(c,{variant:"outlined",onClick:F,disabled:j,children:j?e.jsx(l,{size:24}):"Find Matching Tutors"})]}),e.jsx(J,{component:u,children:e.jsxs(U,{children:[e.jsx(H,{children:e.jsxs(m,{children:[e.jsx(i,{children:"Name"}),e.jsx(i,{children:"Suburb"}),e.jsx(i,{children:"Travel Time"}),e.jsx(i,{align:"right",children:"Actions"})]})}),e.jsx(Q,{children:j?e.jsx(m,{children:e.jsx(i,{colSpan:4,align:"center",children:e.jsx(l,{size:24})})}):d.length>0?d.map(s=>e.jsxs(m,{children:[e.jsx(i,{children:s.full_name}),e.jsx(i,{children:s.suburb}),e.jsx(i,{children:s.travelTime||"N/A"}),e.jsx(i,{align:"right",children:e.jsx(c,{variant:"outlined",size:"small",onClick:()=>z(s.id),disabled:a.status!=="Pending"||S!==null,children:S===s.id?e.jsx(l,{size:24}):"Manual Assign"})})]},s.id)):e.jsx(m,{children:e.jsx(i,{colSpan:4,align:"center",children:'No tutors matched yet. Click "Find Matching Tutors" to begin.'})})})]})}),e.jsxs(u,{sx:{p:2,mt:4},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,sx:{p:2},children:"Event Log"}),e.jsx(B,{dense:!0,children:T.length>0?T.map(s=>e.jsxs(Z,{divider:!0,children:[e.jsx(q,{primary:s.message,secondary:K(new Date(s.created_at),"Australia/Sydney","d MMM yyyy, h:mm:ss a")}),e.jsx(G,{label:s.level,color:V(s.level),size:"small"})]},s.id)):e.jsx(n,{variant:"body2",sx:{p:2},children:"No log entries for this trial yet."})})]})]}):e.jsxs(n,{children:["Trial not found. ",e.jsx(R,{to:"/",children:"Go back to Dashboard"}),"."]})}export{le as default};
