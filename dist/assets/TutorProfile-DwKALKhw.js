import{q as Ce,j as e,r as o,s as c,B as n,c as A,T as s,w as M,A as Pe,P as Ue,b,M as F,S as ee,y as te,E as re,D as ae,G as Te,I as Ae}from"./index-3v-V_ujV.js";import{D as L}from"./DateTimePicker-DPJ1KOfC.js";import{G as Me,P as ke,I as Ie,A as se}from"./PhoneNumberInput-Z0uAPUKV.js";import{u as We,a as De}from"./usePageTitle-seETqNZq.js";import{D as Be}from"./Delete-CFLk6tfJ.js";import{S as Ee}from"./Search-TvqwLMnr.js";import{A as Fe}from"./CheckCircle-DhXPYKmg.js";import{A as v}from"./Alert-Cd_pZj5V.js";import{T as x,F as R,a as Le,I as ie,S as ne}from"./TextField-D9X8XuqD.js";import{F as z}from"./FormControlLabel-XVNslV9S.js";import{C as N}from"./Checkbox-B8l9FLC_.js";import{G as g}from"./Grid-CWEeYFsZ.js";import{D as Re,a as ze,b as Ne,c as qe}from"./DialogTitle-DjXGIgXC.js";import{L as oe}from"./ListItem-Da3YSJce.js";import{f as j}from"./format-CyxUvML0.js";import"./Close-BLRrZJzV.js";import"./useControlled-2upcAsfy.js";import"./isMuiElement-Dd43ylT-.js";const Ge=Ce([e.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),e.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]);function ct(){const[le,q]=o.useState(!0),[G,_]=o.useState(!1),[$,y]=o.useState(""),[d,ce]=o.useState(null),[r,h]=o.useState({suburb:"",phone_number:"",accepts_short_face_to_face_trials:!1,profile_photo_url:"",teaching_bio:"",university:"",degree:"",study_year:"",atar:""}),[w,Y]=o.useState(!1),[ue,O]=o.useState(null),[k,de]=o.useState([]),[p,H]=o.useState(new Set),[S,he]=o.useState(""),[I,pe]=o.useState("All"),[W,me]=o.useState("All"),[xe,D]=o.useState(!1),[J,ge]=o.useState([]),[i,f]=o.useState({start_time:new Date,end_time:new Date,is_recurring:!1,recurrence_pattern:"weekly",recurrence_end_date:new Date(Date.now()+30*24*60*60*1e3),reason:""}),[Q,V]=o.useState(!1);We(r!=null&&r.full_name?`${r.full_name} - Profile`:"Tutor Profile"),o.useEffect(()=>{De("tutor")},[]);const C=o.useCallback(async t=>{const{data:a}=await c.from("tutors").select("*, subjects(id)").eq("id",t).single();a&&(h(a),H(new Set(a.subjects.map(P=>P.id))),a.profile_photo_url&&O(a.profile_photo_url));const{data:l}=await c.from("subjects").select("*").order("state_curriculum, level, name");l&&de(l);const{data:u,error:m}=await c.from("tutor_unavailability").select("*").eq("tutor_id",t).order("start_time",{ascending:!0});ge(u||[]),q(!1)},[]);o.useEffect(()=>{(async()=>{const{data:{session:a}}=await c.auth.getSession();ce(a.user),a.user?await C(a.user.id):q(!1)})()},[C]);const fe=t=>{const a=new Set(p);a.has(t)?a.delete(t):a.add(t),H(a)},K=()=>k.filter(t=>{const a=t.name.toLowerCase().includes(S.toLowerCase())||t.state_curriculum.toLowerCase().includes(S.toLowerCase())||t.level.toLowerCase().includes(S.toLowerCase()),l=I==="All"||t.state_curriculum===I,u=W==="All"||t.level===W;return a&&l&&u}),X=t=>[...new Set(k.map(l=>l[t]))].sort(),ye=()=>k.filter(t=>p.has(t.id)).map(t=>t.name),be=async t=>{const a=t.target.files[0];if(!a)return;if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(a.type.toLowerCase())){alert("Please select a valid image file (JPG, PNG, GIF, or WebP).");return}if(a.size>5*1024*1024){alert(`File size is ${(a.size/(1024*1024)).toFixed(1)}MB. Please select an image smaller than 5MB.`);return}Y(!0),y("");try{const u=a.name.split(".").pop().toLowerCase(),m=`${d.id}-${Date.now()}.${u}`,P=r.profile_photo_url;if(P)try{const T=P.split("/").pop();await c.storage.from("tutor-photos").remove([T])}catch{}const{data:$e,error:U}=await c.storage.from("tutor-photos").upload(m,a,{cacheControl:"3600",upsert:!0});if(U)throw U.message.includes("not found")?new Error("Photo storage bucket not found. Please contact support to set up photo storage."):U.message.includes("policy")?new Error("Permission denied. Please make sure you are logged in as a tutor."):U;const{data:Se}=c.storage.from("tutor-photos").getPublicUrl(m),E=Se.publicUrl,{error:Z}=await c.from("tutors").update({profile_photo_url:E}).eq("id",d.id);if(Z)throw Z;h(T=>({...T,profile_photo_url:E})),O(E),y("âœ… Profile photo updated successfully!"),t.target.value=""}catch(u){let m="Error uploading photo: ";u.message.includes("not found")?m+="Storage bucket not found. Please contact support.":u.message.includes("policy")?m+="Permission denied. Please make sure you are logged in.":u.message.includes("size")?m+="File too large. Please select an image smaller than 5MB.":m+=u.message||"Unknown error occurred.",alert(m)}finally{Y(!1)}},B=t=>t.trim().split(/\s+/).filter(a=>a.length>0).length,ve=["Australian National University","University of Sydney","University of Melbourne","University of Queensland","University of New South Wales","Monash University","University of Western Australia","University of Adelaide","University of Technology Sydney","Queensland University of Technology","RMIT University","Curtin University","Deakin University","Griffith University","La Trobe University","Macquarie University","University of South Australia","University of Tasmania","University of Wollongong","Western Sydney University","Flinders University","James Cook University","Murdoch University","University of Canberra","University of Newcastle","Bond University","Edith Cowan University","Southern Cross University","Swinburne University of Technology","Victoria University","Other"],je=async t=>{t.preventDefault(),_(!0),y("");const a=B(r.teaching_bio);if(r.teaching_bio&&a>50){alert("Teaching bio must be 50 words or less. Current count: "+a),_(!1);return}if(r.atar&&(r.atar<0||r.atar>99.95)){alert("ATAR must be between 0 and 99.95"),_(!1);return}await c.from("tutors").update({suburb:r.suburb,phone_number:r.phone_number,accepts_short_face_to_face_trials:r.accepts_short_face_to_face_trials,teaching_bio:r.teaching_bio,university:r.university,degree:r.degree,study_year:r.study_year,atar:r.atar?parseFloat(r.atar):null}).eq("id",d.id),await c.from("tutor_subjects").delete().eq("tutor_id",d.id);const l=Array.from(p).map(u=>({tutor_id:d.id,subject_id:u}));l.length>0&&await c.from("tutor_subjects").insert(l),y("Profile updated successfully!"),_(!1)},_e=async()=>{if(i.end_time<=i.start_time){alert("End time must be after the start time.");return}if(i.is_recurring&&i.recurrence_end_date<=i.start_time){alert("Recurrence end date must be after the start time.");return}V(!0);const t={tutor_id:d.id,start_time:i.start_time.toISOString(),end_time:i.end_time.toISOString(),reason:i.reason||null,is_recurring:i.is_recurring,recurrence_pattern:i.is_recurring?{type:i.recurrence_pattern,end_date:i.recurrence_end_date.toISOString()}:null},{error:a}=await c.from("tutor_unavailability").insert(t);a?alert("Error adding time block: "+a.message):(y(`${i.is_recurring?"Recurring ":""}unavailability block added successfully!`),f({start_time:new Date,end_time:new Date,is_recurring:!1,recurrence_pattern:"weekly",recurrence_end_date:new Date(Date.now()+30*24*60*60*1e3),reason:""}),await C(d.id)),V(!1)},we=async t=>{if(window.confirm("Are you sure you want to delete this unavailable time block?")){const{error:l}=await c.from("tutor_unavailability").delete().eq("id",t);l?alert("Error deleting time block: "+l.message):await C(d.id)}};return le?e.jsx(n,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(A,{})}):e.jsxs(n,{sx:{p:3,maxWidth:900,margin:"auto"},children:[e.jsx(s,{variant:"h4",gutterBottom:!0,children:"My Profile"}),e.jsxs("form",{onSubmit:je,children:[r.approval_status&&e.jsxs(v,{severity:r.approval_status==="approved"?"success":r.approval_status==="rejected"?"error":r.approval_status==="suspended"?"warning":"info",sx:{mb:3},children:[e.jsxs(s,{variant:"subtitle2",sx:{fontWeight:600},children:["Profile Status: ",r.approval_status.charAt(0).toUpperCase()+r.approval_status.slice(1)]}),e.jsxs(s,{variant:"body2",children:[r.approval_status==="pending"&&"Your profile is under review by our admin team. You will be able to receive student assignments once approved.",r.approval_status==="approved"&&"Your profile has been approved! You can now receive student assignments.",r.approval_status==="rejected"&&"Your profile needs attention. Please update your information and contact support.",r.approval_status==="suspended"&&"Your account is temporarily suspended. Please contact support for assistance."]}),r.approval_notes&&e.jsxs(s,{variant:"body2",sx:{mt:1,fontStyle:"italic"},children:["Admin notes: ",r.approval_notes]}),!r.profile_complete&&e.jsx(s,{variant:"body2",sx:{mt:1,fontWeight:500,color:"warning.main"},children:"âš ï¸ Complete all required fields below to be eligible for approval."})]}),e.jsxs(M,{sx:{p:3,mb:3},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Contact Information"}),e.jsx(x,{label:"Email",value:(d==null?void 0:d.email)||"",fullWidth:!0,disabled:!0,sx:{mb:2}}),e.jsx(Me,{value:r.suburb,onChange:t=>h({...r,suburb:t}),label:"Suburb",placeholder:"Start typing your suburb or area...",required:!0,helperText:"Enter your suburb or area to help match you with nearby students",types:["(cities)"],componentRestrictions:{country:"AU"},sx:{mb:2}}),e.jsx(ke,{label:"Phone Number",value:r.phone_number||"",onChange:t=>h({...r,phone_number:t.target.value}),fullWidth:!0,required:!0,sx:{mb:2},helperText:"This will be used to contact you about trial sessions"}),e.jsxs(R,{sx:{mb:2},children:[e.jsx(z,{control:e.jsx(N,{checked:r.accepts_short_face_to_face_trials||!1,onChange:t=>h({...r,accepts_short_face_to_face_trials:t.target.checked})}),label:"I accept short face-to-face trials (less than 1 hour)"}),e.jsx(Le,{children:"Enable this if you're willing to conduct face-to-face tutoring sessions that are shorter than the standard 1 hour duration."})]})]}),e.jsxs(M,{sx:{p:3,mb:3},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"Profile Information"}),e.jsx(s,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"This information will be shared with parents when you accept a trial session."}),e.jsxs(n,{sx:{mb:3},children:[e.jsx(s,{variant:"subtitle1",gutterBottom:!0,children:"Profile Photo"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Pe,{src:ue,sx:{width:100,height:100,border:"3px solid",borderColor:"primary.main"},children:e.jsx(Ue,{sx:{fontSize:40}})}),e.jsxs(n,{children:[e.jsx("input",{accept:"image/*",style:{display:"none"},id:"photo-upload",type:"file",onChange:be}),e.jsx("label",{htmlFor:"photo-upload",children:e.jsx(b,{variant:"outlined",component:"span",startIcon:w?e.jsx(A,{size:20}):e.jsx(Ge,{}),disabled:w,children:w?"Uploading...":"Upload Photo"})}),e.jsx(s,{variant:"caption",display:"block",sx:{mt:1,color:"text.secondary"},children:"Max 5MB. JPG, PNG, GIF, or WebP format."}),w&&e.jsx(s,{variant:"caption",display:"block",sx:{mt:.5,color:"info.main"},children:"ðŸ“¤ Uploading your photo..."})]})]})]}),e.jsx(n,{sx:{mb:3},children:e.jsx(x,{label:"Why I Teach (Bio)",multiline:!0,rows:3,fullWidth:!0,value:r.teaching_bio||"",onChange:t=>h({...r,teaching_bio:t.target.value}),placeholder:"Share why you love teaching and what motivates you to help students succeed...",helperText:`${B(r.teaching_bio||"")} / 50 words maximum`,error:B(r.teaching_bio||"")>50})}),e.jsx(s,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,mb:2},children:"Education Background"}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:12,md:6,children:e.jsxs(R,{fullWidth:!0,children:[e.jsx(ie,{children:"University"}),e.jsx(ne,{value:r.university||"",label:"University",onChange:t=>h({...r,university:t.target.value}),children:ve.map(t=>e.jsx(F,{value:t,children:t},t))})]})}),e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"Degree Program",fullWidth:!0,value:r.degree||"",onChange:t=>h({...r,degree:t.target.value}),placeholder:"e.g., Bachelor of Engineering, Master of Education"})}),e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"Study Year / Graduation Year",fullWidth:!0,value:r.study_year||"",onChange:t=>h({...r,study_year:t.target.value}),placeholder:"e.g., 2nd Year, Graduated 2023"})}),e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(x,{label:"ATAR (Optional)",type:"number",fullWidth:!0,value:r.atar||"",onChange:t=>h({...r,atar:t.target.value}),placeholder:"e.g., 95.50",inputProps:{min:0,max:99.95,step:.05},helperText:"Australian Tertiary Admission Rank (0-99.95)"})})]}),e.jsx(v,{severity:"info",sx:{mt:2},children:e.jsxs(s,{variant:"body2",children:[e.jsx("strong",{children:"Privacy Note:"})," This profile information will only be shared with parents after you accept their trial session request. It helps parents understand your background and teaching approach."]})})]}),e.jsxs(M,{sx:{p:3,mb:3},children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(s,{variant:"h6",children:"Teaching Subjects"}),e.jsxs(b,{variant:"outlined",startIcon:e.jsx(ee,{}),onClick:()=>D(!0),children:["Manage Subjects (",p.size,")"]})]}),p.size===0?e.jsx(v,{severity:"warning",children:'No subjects selected. Click "Manage Subjects" to choose your teaching subjects.'}):e.jsxs(n,{children:[e.jsxs(s,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:["Selected Subjects (",p.size,"):"]}),e.jsx(n,{display:"flex",flexWrap:"wrap",gap:1,children:ye().map(t=>e.jsx(te,{label:t,color:"primary",variant:"outlined",icon:e.jsx(Fe,{}),size:"small"},t))})]})]}),e.jsxs(Re,{open:xe,onClose:()=>D(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(ee,{}),"Select Your Teaching Subjects"]})}),e.jsxs(Ne,{children:[e.jsxs(g,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(x,{fullWidth:!0,placeholder:"Search subjects...",value:S,onChange:t=>he(t.target.value),InputProps:{startAdornment:e.jsx(Ie,{position:"start",children:e.jsx(Ee,{})})}})}),e.jsx(g,{item:!0,xs:12,md:3,children:e.jsx(se,{options:["All",...X("state_curriculum")],value:I,onChange:(t,a)=>pe(a),renderInput:t=>e.jsx(x,{...t,label:"Curriculum"})})}),e.jsx(g,{item:!0,xs:12,md:3,children:e.jsx(se,{options:["All",...X("level")],value:W,onChange:(t,a)=>me(a),renderInput:t=>e.jsx(x,{...t,label:"Level"})})})]}),e.jsx(n,{sx:{maxHeight:400,overflow:"auto",border:1,borderColor:"divider",borderRadius:1},children:K().length===0?e.jsx(n,{p:3,textAlign:"center",children:e.jsx(s,{color:"text.secondary",children:"No subjects found matching your criteria."})}):e.jsx(re,{children:K().map(t=>e.jsx(oe,{divider:!0,children:e.jsx(z,{control:e.jsx(N,{checked:p.has(t.id),onChange:()=>fe(t.id)}),label:e.jsxs(n,{children:[e.jsx(s,{variant:"body1",fontWeight:"bold",children:t.name}),e.jsxs(s,{variant:"caption",color:"text.secondary",children:[t.state_curriculum," â€¢ ",t.level,t.subject_group&&` â€¢ ${t.subject_group}`]})]}),sx:{margin:0,width:"100%"}})},t.id))})}),e.jsx(n,{mt:2,p:2,bgcolor:"grey.50",borderRadius:1,children:e.jsxs(s,{variant:"body2",color:"primary",fontWeight:"bold",children:["Selected: ",p.size," subjects"]})})]}),e.jsx(qe,{children:e.jsxs(b,{onClick:()=>D(!1),children:["Done (",p.size," selected)"]})})]}),e.jsxs(M,{sx:{p:3,mb:3},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,children:"My Availability"}),e.jsx(s,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Block out times when you are unavailable for new trial lessons."}),e.jsx(ae,{sx:{my:2}}),e.jsx(s,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Current Unavailable Times"}),e.jsx(re,{dense:!0,children:J.length>0?J.map(t=>{var a,l;return e.jsx(oe,{secondaryAction:e.jsx(Ae,{edge:"end","aria-label":"delete",onClick:()=>we(t.id),children:e.jsx(Be,{})}),children:e.jsx(Te,{primary:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(s,{variant:"body2",sx:{fontWeight:500},children:`${j(new Date(t.start_time),"d MMM yyyy, h:mm a")} - ${j(new Date(t.end_time),"d MMM yyyy, h:mm a")}`}),t.is_recurring&&e.jsx(te,{size:"small",label:`Recurring ${((a=t.recurrence_pattern)==null?void 0:a.type)||"weekly"}`,color:"info",variant:"outlined"})]}),secondary:e.jsxs(n,{children:[t.reason&&e.jsxs(s,{variant:"caption",color:"text.secondary",children:["Reason: ",t.reason]}),t.is_recurring&&((l=t.recurrence_pattern)==null?void 0:l.end_date)&&e.jsxs(s,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Repeats until: ",j(new Date(t.recurrence_pattern.end_date),"d MMM yyyy")]})]})})},t.id)}):e.jsx(s,{variant:"body2",sx:{p:1},children:"You have no unavailable times scheduled."})}),e.jsx(ae,{sx:{my:2}}),e.jsx(s,{variant:"subtitle1",sx:{fontWeight:"bold",mb:2},children:"Add New Unavailable Time"}),e.jsx(z,{control:e.jsx(N,{checked:i.is_recurring,onChange:t=>f(a=>({...a,is_recurring:t.target.checked}))}),label:"Make this a recurring unavailability",sx:{mb:2}}),e.jsx(x,{fullWidth:!0,label:"Reason (optional)",value:i.reason,onChange:t=>f(a=>({...a,reason:t.target.value})),placeholder:"e.g., University classes, Work commitments",sx:{mb:2},helperText:"Providing a reason helps with scheduling decisions"}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap",mb:2},children:[e.jsxs(n,{children:[e.jsx(s,{variant:"caption",children:"Start Time"}),e.jsx(L,{onChange:t=>f({...i,start_time:t}),value:i.start_time})]}),e.jsxs(n,{children:[e.jsx(s,{variant:"caption",children:"End Time"}),e.jsx(L,{onChange:t=>f({...i,end_time:t}),value:i.end_time})]})]}),i.is_recurring&&e.jsxs(n,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:2,mb:2,bgcolor:"rgba(33, 150, 243, 0.04)"},children:[e.jsx(s,{variant:"subtitle2",sx:{mb:2,fontWeight:600,color:"primary.main"},children:"ðŸ”„ Recurring Settings"}),e.jsxs(n,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap"},children:[e.jsxs(R,{sx:{minWidth:150},children:[e.jsx(ie,{children:"Repeat Pattern"}),e.jsxs(ne,{value:i.recurrence_pattern,label:"Repeat Pattern",onChange:t=>f(a=>({...a,recurrence_pattern:t.target.value})),children:[e.jsx(F,{value:"weekly",children:"Weekly (every 7 days)"}),e.jsx(F,{value:"fortnightly",children:"Fortnightly (every 14 days)"})]})]}),e.jsxs(n,{children:[e.jsx(s,{variant:"caption",children:"Repeat Until"}),e.jsx(L,{onChange:t=>f(a=>({...a,recurrence_end_date:t})),value:i.recurrence_end_date})]})]}),e.jsx(v,{severity:"info",sx:{mt:1},children:e.jsxs(s,{variant:"caption",children:["This will create recurring unavailability blocks ",i.recurrence_pattern,"from ",j(i.start_time,"MMM d, yyyy")," until ",j(i.recurrence_end_date,"MMM d, yyyy"),". Each block will be ",Math.round((i.end_time-i.start_time)/(1e3*60*60))," hours long."]})})]}),e.jsx(b,{variant:"contained",color:"secondary",onClick:_e,disabled:Q,size:"large",sx:{minWidth:200,background:i.is_recurring?"linear-gradient(135deg, #2196F3 0%, #FF9800 100%)":void 0},children:Q?e.jsx(A,{size:24,color:"inherit"}):`Add ${i.is_recurring?"Recurring ":""}Unavailable Time`})]}),e.jsx(b,{type:"submit",variant:"contained",sx:{mt:1},disabled:G,children:G?e.jsx(A,{size:24}):"Save Full Profile"}),$&&e.jsx(v,{severity:"success",sx:{mt:2},children:$})]})]})}export{ct as default};
