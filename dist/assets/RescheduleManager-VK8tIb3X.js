import{q as de,j as e,r as l,s as G,B as m,c as w,T as t,b as d,C as b,a as _,w as C,M as he,y as V}from"./index-3v-V_ujV.js";import{D as ue}from"./DateTimePicker-DPJ1KOfC.js";import{S as U}from"./Schedule-DNHXDbJX.js";import{A as xe}from"./CheckCircle-DhXPYKmg.js";import{R as me}from"./Cancel-4DEfXCDE.js";import{G as a}from"./Grid-CWEeYFsZ.js";import{T as je,a as pe,b as ye,c as Z,d as o,e as fe}from"./TableRow-Ch5q5_jA.js";import{f as h}from"./index-DyFXVJrh.js";import{D as K,a as Q,b as X,c as Y}from"./DialogTitle-DjXGIgXC.js";import{F as ge,I as be,S as _e,T as ve}from"./TextField-D9X8XuqD.js";import{A as Re}from"./Alert-Cd_pZj5V.js";import"./isMuiElement-Dd43ylT-.js";import"./format-CyxUvML0.js";import"./useControlled-2upcAsfy.js";import"./Close-BLRrZJzV.js";const Se=de([e.jsx("circle",{cx:"12",cy:"19",r:"2"},"0"),e.jsx("path",{d:"M10 3h4v12h-4z"},"1")]),A="https://tutor-matching-backend.onrender.com";function Fe(){var k,O,H,z,F,B,W,$,L;const[ee,q]=l.useState(!0),[u,se]=l.useState([]),[r,v]=l.useState(null),[te,j]=l.useState(!1),[re,g]=l.useState(!1),[T,M]=l.useState(new Date),[R,D]=l.useState(""),[S,I]=l.useState(""),[ne,ie]=l.useState([]),[p,x]=l.useState(!1),y=l.useCallback(async()=>{q(!0);try{const{data:s,error:n}=await G.from("reschedule_requests").select(`
                    *,
                    trial_sessions (
                        id,
                        parent_name,
                        location,
                        assigned_tutor_id,
                        trial_lessons (
                            student_name,
                            lesson_datetime,
                            subjects (name)
                        )
                    ),
                    priority_tutor:priority_tutor_id (
                        full_name,
                        email
                    )
                `).order("created_at",{ascending:!1});if(n)throw n;se(s||[])}catch(s){console.error("Error fetching reschedule requests:",s)}finally{q(!1)}},[]),E=l.useCallback(async()=>{try{const{data:s,error:n}=await G.from("trial_sessions").select(`
                    id,
                    parent_name,
                    location,
                    status,
                    trial_lessons (
                        student_name,
                        lesson_datetime,
                        subjects (name)
                    )
                `).in("status",["Confirmed","Outreach in Progress"]).order("created_at",{ascending:!1}).limit(50);if(n)throw n;ie(s||[])}catch(s){console.error("Error fetching sessions:",s)}},[]);l.useEffect(()=>{y(),E()},[y,E]);const N=s=>{const n={pending:{color:"warning",label:"Pending",icon:e.jsx(Se,{fontSize:"small"})},approved:{color:"success",label:"Approved",icon:e.jsx(xe,{fontSize:"small"})},rejected:{color:"error",label:"Rejected",icon:e.jsx(me,{fontSize:"small"})},expired:{color:"default",label:"Expired",icon:e.jsx(U,{fontSize:"small"})}},i=n[s]||n.pending;return e.jsx(V,{size:"small",color:i.color,label:i.label,icon:i.icon})},P=s=>{const n={tutor:{color:"primary",label:"Tutor Request"},parent:{color:"secondary",label:"Parent Request"},admin:{color:"info",label:"Admin Request"}},i=n[s]||n.admin;return e.jsx(V,{size:"small",variant:"outlined",color:i.color,label:i.label})},ae=async()=>{if(!S||!R.trim()){alert("Please select a session and provide a reason.");return}x(!0);try{const s=await fetch(`${A}/api/sessions/${S}/reschedule`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({newDateTime:T.toISOString(),reason:R,requesterId:"admin",requesterType:"admin"})}),n=await s.json();if(s.ok)g(!1),I(""),D(""),M(new Date),y(),alert("Reschedule request created successfully!");else throw new Error(n.error||"Failed to create reschedule request")}catch(s){console.error("Error creating reschedule request:",s),alert("Failed to create reschedule request: "+s.message)}finally{x(!1)}},oe=async s=>{if(window.confirm("Are you sure you want to approve this reschedule request?")){x(!0);try{const n=await fetch(`${A}/api/reschedule-requests/${s}/respond`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:"accepted",tutorId:r.priority_tutor_id})}),i=await n.json();if(n.ok)y(),v(null),j(!1),alert("Reschedule request approved successfully!");else throw new Error(i.error||"Failed to approve request")}catch(n){console.error("Error approving request:",n),alert("Failed to approve request: "+n.message)}finally{x(!1)}}},le=async s=>{if(prompt("Please provide a reason for rejection:")){x(!0);try{const i=await fetch(`${A}/api/reschedule-requests/${s}/respond`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:"declined",tutorId:r.priority_tutor_id})}),c=await i.json();if(i.ok)y(),v(null),j(!1),alert("Reschedule request rejected. New tutor search will begin.");else throw new Error(c.error||"Failed to reject request")}catch(i){console.error("Error rejecting request:",i),alert("Failed to reject request: "+i.message)}finally{x(!1)}}},ce=s=>{v(s),j(!0)};return ee?e.jsx(m,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(w,{})}):e.jsxs(m,{sx:{p:3},children:[e.jsxs(m,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsx(t,{variant:"h4",component:"h1",children:"ðŸ”„ Reschedule Management"}),e.jsx(d,{variant:"contained",startIcon:e.jsx(U,{}),onClick:()=>g(!0),children:"Create Reschedule Request"})]}),e.jsxs(a,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(a,{item:!0,xs:12,sm:6,md:3,children:e.jsx(b,{children:e.jsxs(_,{sx:{textAlign:"center"},children:[e.jsx(t,{variant:"h4",color:"warning.main",children:u.filter(s=>s.status==="pending").length}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Pending Requests"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:3,children:e.jsx(b,{children:e.jsxs(_,{sx:{textAlign:"center"},children:[e.jsx(t,{variant:"h4",color:"success.main",children:u.filter(s=>s.status==="approved").length}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Approved"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:3,children:e.jsx(b,{children:e.jsxs(_,{sx:{textAlign:"center"},children:[e.jsx(t,{variant:"h4",color:"error.main",children:u.filter(s=>s.status==="rejected").length}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Rejected"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:3,children:e.jsx(b,{children:e.jsxs(_,{sx:{textAlign:"center"},children:[e.jsx(t,{variant:"h4",color:"text.secondary",children:u.filter(s=>s.status==="expired").length}),e.jsx(t,{variant:"body2",color:"text.secondary",children:"Expired"})]})})})]}),e.jsxs(C,{children:[e.jsx(je,{children:e.jsxs(pe,{children:[e.jsx(ye,{children:e.jsxs(Z,{children:[e.jsx(o,{children:e.jsx("strong",{children:"Created"})}),e.jsx(o,{children:e.jsx("strong",{children:"Session"})}),e.jsx(o,{children:e.jsx("strong",{children:"Requester"})}),e.jsx(o,{children:e.jsx("strong",{children:"Original Time"})}),e.jsx(o,{children:e.jsx("strong",{children:"Requested Time"})}),e.jsx(o,{children:e.jsx("strong",{children:"Status"})}),e.jsx(o,{children:e.jsx("strong",{children:"Priority Deadline"})}),e.jsx(o,{children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(fe,{children:u.map(s=>{var n,i,c,f;return e.jsxs(Z,{hover:!0,children:[e.jsx(o,{children:e.jsx(t,{variant:"body2",children:h(new Date(s.created_at),"Australia/Sydney","dd/MM HH:mm")})}),e.jsxs(o,{children:[e.jsx(t,{variant:"body2",fontWeight:"medium",children:((n=s.trial_sessions)==null?void 0:n.parent_name)||"N/A"}),e.jsx(t,{variant:"caption",color:"text.secondary",children:((f=(c=(i=s.trial_sessions)==null?void 0:i.trial_lessons)==null?void 0:c[0])==null?void 0:f.student_name)||"N/A"})]}),e.jsxs(o,{children:[P(s.requester_type),s.priority_tutor&&e.jsx(t,{variant:"caption",display:"block",children:s.priority_tutor.full_name})]}),e.jsx(o,{children:e.jsx(t,{variant:"body2",children:s.original_datetime?h(new Date(s.original_datetime),"Australia/Sydney","dd/MM @ HH:mm"):"N/A"})}),e.jsx(o,{children:e.jsx(t,{variant:"body2",children:s.requested_datetime?h(new Date(s.requested_datetime),"Australia/Sydney","dd/MM @ HH:mm"):"To be set"})}),e.jsx(o,{children:N(s.status)}),e.jsx(o,{children:s.priority_response_deadline?e.jsx(t,{variant:"caption",children:h(new Date(s.priority_response_deadline),"Australia/Sydney","dd/MM HH:mm")}):e.jsx(t,{variant:"caption",color:"text.secondary",children:"No deadline"})}),e.jsx(o,{children:e.jsx(d,{size:"small",onClick:()=>ce(s),children:"View"})})]},s.id)})})]})}),u.length===0&&e.jsx(m,{p:4,textAlign:"center",children:e.jsx(t,{color:"text.secondary",children:"No reschedule requests found."})})]}),e.jsxs(K,{open:re,onClose:()=>g(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Q,{children:"Create New Reschedule Request"}),e.jsx(X,{children:e.jsxs(a,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(a,{item:!0,xs:12,children:e.jsxs(ge,{fullWidth:!0,children:[e.jsx(be,{children:"Select Session"}),e.jsx(_e,{value:S,label:"Select Session",onChange:s=>I(s.target.value),children:ne.map(s=>{var n,i,c,f,J;return e.jsxs(he,{value:s.id,children:[s.parent_name," - ",((i=(n=s.trial_lessons)==null?void 0:n[0])==null?void 0:i.student_name)||"N/A","(",((J=(f=(c=s.trial_lessons)==null?void 0:c[0])==null?void 0:f.subjects)==null?void 0:J.name)||"N/A",")"]},s.id)})})]})}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"New Date & Time"}),e.jsx(ue,{value:T,onChange:M,calendarIcon:null,clearIcon:null,format:"dd/MM/yyyy h:mm a",minDate:new Date})]}),e.jsx(a,{item:!0,xs:12,children:e.jsx(ve,{fullWidth:!0,multiline:!0,rows:3,label:"Reason for Reschedule",value:R,onChange:s=>D(s.target.value),placeholder:"Explain why this session needs to be rescheduled..."})})]})}),e.jsxs(Y,{children:[e.jsx(d,{onClick:()=>g(!1),children:"Cancel"}),e.jsx(d,{variant:"contained",onClick:ae,disabled:p,children:p?e.jsx(w,{size:20}):"Create Request"})]})]}),e.jsxs(K,{open:te,onClose:()=>j(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(Q,{children:["Reschedule Request Details",r&&e.jsxs(m,{mt:1,children:[N(r.status),P(r.requester_type)]})]}),e.jsx(X,{children:r&&e.jsxs(m,{children:[r.priority_tutor&&r.status==="pending"&&e.jsxs(Re,{severity:"info",sx:{mb:2},children:[e.jsx("strong",{children:"Priority Response:"})," ",r.priority_tutor.full_name," has priority until"," ",r.priority_response_deadline?h(new Date(r.priority_response_deadline),"Australia/Sydney","dd/MM/yyyy @ h:mm a"):"no deadline set"]}),e.jsxs(a,{container:!0,spacing:2,children:[e.jsxs(a,{item:!0,xs:12,sm:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Session"}),e.jsx(t,{variant:"body1",children:((k=r.trial_sessions)==null?void 0:k.parent_name)||"N/A"}),e.jsxs(t,{variant:"body2",color:"text.secondary",children:[((z=(H=(O=r.trial_sessions)==null?void 0:O.trial_lessons)==null?void 0:H[0])==null?void 0:z.student_name)||"N/A"," - "," ",(($=(W=(B=(F=r.trial_sessions)==null?void 0:F.trial_lessons)==null?void 0:B[0])==null?void 0:W.subjects)==null?void 0:$.name)||"N/A"]})]}),e.jsxs(a,{item:!0,xs:12,sm:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Location"}),e.jsx(t,{variant:"body1",children:((L=r.trial_sessions)==null?void 0:L.location)||"N/A"})]}),e.jsxs(a,{item:!0,xs:12,sm:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Original Time"}),e.jsx(t,{variant:"body1",children:r.original_datetime?h(new Date(r.original_datetime),"Australia/Sydney","EEEE, d MMMM yyyy @ h:mm a"):"N/A"})]}),e.jsxs(a,{item:!0,xs:12,sm:6,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",children:"Requested Time"}),e.jsx(t,{variant:"body1",children:r.requested_datetime?h(new Date(r.requested_datetime),"Australia/Sydney","EEEE, d MMMM yyyy @ h:mm a"):"To be determined"})]}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Reason"}),e.jsx(C,{sx:{p:2,bgcolor:"grey.50"},children:e.jsx(t,{variant:"body2",children:r.reason||"No reason provided"})})]}),r.admin_notes&&e.jsxs(a,{item:!0,xs:12,children:[e.jsx(t,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Admin Notes"}),e.jsx(C,{sx:{p:2,bgcolor:"grey.50"},children:e.jsx(t,{variant:"body2",children:r.admin_notes})})]})]})]})}),e.jsxs(Y,{children:[e.jsx(d,{onClick:()=>j(!1),children:"Close"}),(r==null?void 0:r.status)==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(d,{color:"error",onClick:()=>le(r.id),disabled:p,children:"Reject"}),e.jsx(d,{variant:"contained",color:"success",onClick:()=>oe(r.id),disabled:p,children:p?e.jsx(w,{size:20}):"Approve"})]})]})]})]})}export{Fe as default};
