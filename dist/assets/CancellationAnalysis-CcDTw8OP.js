import{q as U,j as e,r as o,s as q,B as h,c as T,T as n,b as u,C as m,a as j,w as C,y as c,z as J}from"./index-3v-V_ujV.js";import{A as Z,a as K,E as Q,b as X}from"./ExpandMore-XLMqhgyC.js";import{A as Y}from"./Analytics-lIFs4u_p.js";import{O as z}from"./AdminPanelSettings-BxfCYMFZ.js";import{G as a}from"./Grid-CWEeYFsZ.js";import{T as ee,a as re,b as ne,c as D,d as t,e as se}from"./TableRow-Ch5q5_jA.js";import{f as E}from"./index-DyFXVJrh.js";import{R as te}from"./Rating-fyB5SVPr.js";import{D as ie,a as ae,b as le,c as oe}from"./DialogTitle-DjXGIgXC.js";import{A as F}from"./Alert-Cd_pZj5V.js";import{T as k}from"./TextField-D9X8XuqD.js";import"./useControlled-2upcAsfy.js";import"./isMuiElement-Dd43ylT-.js";import"./format-CyxUvML0.js";import"./Close-BLRrZJzV.js";const ce=U(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),de="https://tutor-matching-backend.onrender.com";function Se(){const[S,I]=o.useState(!0),[w,M]=o.useState([]),[l,H]=o.useState(null),[N,y]=o.useState(!1),[d,R]=o.useState({overridePenalty:0,overrideReason:"",adminId:null}),[O,P]=o.useState(!1),[x,L]=o.useState({totalAnalyses:0,averageSentimentScore:0,averagePenalty:0,overrideRate:0,emergencyRate:0,poorReasonRate:0}),p=o.useCallback(async()=>{I(!0);try{const{data:r,error:s}=await q.from("cancellation_analysis").select(`
                    *,
                    tutors(full_name, email),
                    trial_sessions(parent_name, status, trial_lessons(*, subjects(name)))
                `).order("cancellation_time",{ascending:!1});if(s)throw s;M(r||[]),W(r||[])}catch(r){console.error("Error fetching cancellation analyses:",r)}finally{I(!1)}},[]),W=r=>{if(r.length===0)return;const s=r.length,v=r.reduce((i,_)=>i+(_.ai_sentiment_score||0),0)/s,g=r.reduce((i,_)=>i+(_.final_penalty||_.calculated_penalty||0),0)/s,b=r.filter(i=>i.admin_override).length,f=r.filter(i=>(i.ai_sentiment_score||0)>=.8).length,A=r.filter(i=>(i.ai_sentiment_score||0)<=.3).length;L({totalAnalyses:s,averageSentimentScore:v,averagePenalty:g,overrideRate:b/s*100,emergencyRate:f/s*100,poorReasonRate:A/s*100})};o.useEffect(()=>{p()},[p]);const V=r=>{H(r),R({overridePenalty:r.final_penalty||r.calculated_penalty||0,overrideReason:"",adminId:null}),y(!0)},$=async()=>{if(!l||!d.overrideReason.trim()){alert("Please provide a reason for the override.");return}P(!0);try{const r=await fetch(`${de}/api/cancellation-analysis/${l.id}/override`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({overridePenalty:parseFloat(d.overridePenalty),overrideReason:d.overrideReason,adminId:"admin-user"})}),s=await r.json();r.ok?(alert("Override applied successfully!"),y(!1),await p()):alert("Error: "+(s.error||"Failed to apply override"))}catch(r){console.error("Error submitting override:",r),alert("Failed to submit override")}finally{P(!1)}},B=r=>r>=.8?e.jsx(c,{size:"small",color:"success",label:"Valid Emergency"}):r>=.5?e.jsx(c,{size:"small",color:"warning",label:"Reasonable Excuse"}):e.jsx(c,{size:"small",color:"error",label:"Poor Excuse"}),G=r=>r<=1?e.jsx(c,{size:"small",color:"success",label:"Low Penalty"}):r<=3?e.jsx(c,{size:"small",color:"warning",label:"Medium Penalty"}):e.jsx(c,{size:"small",color:"error",label:"High Penalty"});return S?e.jsx(h,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(T,{})}):e.jsxs(h,{sx:{p:3},children:[e.jsxs(h,{display:"flex",justifyContent:"between",alignItems:"center",mb:3,children:[e.jsx(n,{variant:"h4",component:"h1",children:"🤖 AI Cancellation Analysis"}),e.jsx(u,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:p,disabled:S,children:"Refresh"})]}),e.jsxs(a,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsx(n,{variant:"h4",color:"primary",children:x.totalAnalyses}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Total Analyses"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsx(n,{variant:"h4",color:"info.main",children:x.averageSentimentScore.toFixed(2)}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Avg Sentiment Score"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsx(n,{variant:"h4",color:"warning.main",children:x.averagePenalty.toFixed(1)}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Avg Penalty Applied"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsxs(n,{variant:"h4",color:"error.main",children:[x.overrideRate.toFixed(1),"%"]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Admin Override Rate"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsxs(n,{variant:"h4",color:"success.main",children:[x.emergencyRate.toFixed(1),"%"]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Valid Emergencies"})]})})}),e.jsx(a,{item:!0,xs:12,sm:6,md:2,children:e.jsx(m,{children:e.jsxs(j,{sx:{textAlign:"center",p:2},children:[e.jsxs(n,{variant:"h4",color:"error.main",children:[x.poorReasonRate.toFixed(1),"%"]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Poor Excuses"})]})})})]}),e.jsxs(C,{children:[e.jsx(ee,{children:e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs(D,{children:[e.jsx(t,{children:e.jsx("strong",{children:"Date"})}),e.jsx(t,{children:e.jsx("strong",{children:"Tutor"})}),e.jsx(t,{children:e.jsx("strong",{children:"Session"})}),e.jsx(t,{children:e.jsx("strong",{children:"Notice (Hours)"})}),e.jsx(t,{children:e.jsx("strong",{children:"AI Sentiment"})}),e.jsx(t,{children:e.jsx("strong",{children:"Penalty Applied"})}),e.jsx(t,{children:e.jsx("strong",{children:"Override"})}),e.jsx(t,{children:e.jsx("strong",{children:"Actions"})})]})}),e.jsx(se,{children:w.map(r=>{var s,v,g,b,f,A,i;return e.jsxs(D,{hover:!0,children:[e.jsx(t,{children:e.jsx(n,{variant:"body2",children:E(new Date(r.cancellation_time),"Australia/Sydney","dd/MM/yyyy HH:mm")})}),e.jsxs(t,{children:[e.jsx(n,{variant:"body2",fontWeight:"bold",children:((s=r.tutors)==null?void 0:s.full_name)||"Unknown Tutor"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:((v=r.tutors)==null?void 0:v.email)||"No email"})]}),e.jsxs(t,{children:[e.jsx(n,{variant:"body2",children:((g=r.trial_sessions)==null?void 0:g.parent_name)||"N/A"}),e.jsx(n,{variant:"caption",color:"text.secondary",children:((i=(A=(f=(b=r.trial_sessions)==null?void 0:b.trial_lessons)==null?void 0:f[0])==null?void 0:A.subjects)==null?void 0:i.name)||"Unknown Subject"})]}),e.jsx(t,{children:e.jsx(c,{size:"small",label:`${r.notice_hours.toFixed(1)}h`,color:r.notice_hours<4?"error":r.notice_hours<12?"warning":"success"})}),e.jsxs(t,{children:[e.jsxs(h,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(te,{value:r.ai_sentiment_score||0,max:1,precision:.1,size:"small",readOnly:!0}),e.jsxs(n,{variant:"caption",children:[((r.ai_sentiment_score||0)*100).toFixed(0),"%"]})]}),B(r.ai_sentiment_score||0)]}),e.jsxs(t,{children:[e.jsxs(n,{variant:"body2",fontWeight:"bold",children:["-",(r.final_penalty||r.calculated_penalty||0).toFixed(2)]}),G(r.final_penalty||r.calculated_penalty||0)]}),e.jsx(t,{children:r.admin_override?e.jsx(c,{size:"small",color:"info",label:"Override Applied"}):e.jsx(c,{size:"small",color:"default",label:"AI Decision"})}),e.jsx(t,{children:e.jsxs(J,{direction:"row",spacing:1,children:[e.jsx(u,{size:"small",startIcon:e.jsx(ce,{}),onClick:()=>{alert(`Reason: "${r.cancellation_reason}"

AI Analysis: "${r.ai_analysis||"No analysis available"}"`)},children:"View"}),e.jsx(u,{size:"small",variant:"outlined",startIcon:e.jsx(z,{}),onClick:()=>V(r),disabled:r.admin_override,children:"Override"})]})})]},r.id)})})]})}),w.length===0&&e.jsx(h,{p:4,textAlign:"center",children:e.jsx(n,{color:"text.secondary",children:"No cancellation analyses found. AI analysis will appear here when tutors cancel sessions."})})]}),e.jsxs(ie,{open:N,onClose:()=>y(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ae,{children:"🛡️ Admin Override - AI Cancellation Analysis"}),e.jsx(le,{children:l&&e.jsxs(h,{sx:{mt:2},children:[e.jsxs(F,{severity:"info",sx:{mb:2},children:[e.jsx("strong",{children:"Original AI Decision:"})," ",((l.ai_sentiment_score||0)*100).toFixed(0),"% validity score, penalty: -",(l.calculated_penalty||0).toFixed(2)," points"]}),e.jsxs(Z,{sx:{mb:2},children:[e.jsx(K,{expandIcon:e.jsx(Q,{}),children:e.jsx(n,{variant:"h6",children:"Cancellation Details"})}),e.jsx(X,{children:e.jsxs(a,{container:!0,spacing:2,children:[e.jsxs(a,{item:!0,xs:12,children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Tutor's Reason:"}),e.jsx(C,{sx:{p:2,bgcolor:"grey.50"},children:e.jsxs(n,{variant:"body2",children:['"',l.cancellation_reason,'"']})})]}),e.jsxs(a,{item:!0,xs:12,children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"AI Analysis:"}),e.jsx(C,{sx:{p:2,bgcolor:"grey.50"},children:e.jsx(n,{variant:"body2",children:l.ai_analysis||"No AI analysis available"})})]}),e.jsxs(a,{item:!0,xs:6,children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Notice Given:"}),e.jsxs(n,{variant:"body1",children:[l.notice_hours.toFixed(1)," hours"]})]}),e.jsxs(a,{item:!0,xs:6,children:[e.jsx(n,{variant:"subtitle2",color:"text.secondary",children:"Cancellation Time:"}),e.jsx(n,{variant:"body1",children:E(new Date(l.cancellation_time),"Australia/Sydney","dd/MM/yyyy HH:mm")})]})]})})]}),e.jsx(k,{label:"Override Penalty",type:"number",value:d.overridePenalty,onChange:r=>R(s=>({...s,overridePenalty:r.target.value})),helperText:"Enter the penalty you want to apply (negative number for penalty, positive for bonus)",fullWidth:!0,sx:{mb:2},inputProps:{step:.1,min:-10,max:5}}),e.jsx(k,{label:"Override Reason",multiline:!0,rows:3,value:d.overrideReason,onChange:r=>R(s=>({...s,overrideReason:r.target.value})),placeholder:"Explain why you are overriding the AI decision...",fullWidth:!0,required:!0,sx:{mb:2}}),e.jsx(F,{severity:"warning",children:"This will adjust the tutor's availability score and override the AI decision permanently."})]})}),e.jsxs(oe,{children:[e.jsx(u,{onClick:()=>y(!1),children:"Cancel"}),e.jsx(u,{variant:"contained",onClick:$,disabled:O||!d.overrideReason.trim(),startIcon:O?e.jsx(T,{size:20}):e.jsx(z,{}),children:"Apply Override"})]})]})]})}export{Se as default};
